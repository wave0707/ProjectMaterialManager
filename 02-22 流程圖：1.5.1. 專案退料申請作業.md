# 流程圖：1.5.1. 專案退料申請作業

* **文件版本**: 1.0
* **制定日期**: 2025年7月5日
* **制定者**: William He
* **模組**：1.5. 退貨入庫
* **文件狀態**：流程圖語法已更新為 Mermaid。

---

這份流程圖詳細描述了案場人員在工程結束或發現物料多領、誤領時，將物料從案場退回倉庫，並在系統中提出申請的完整操作步驟。

### 流程圖說明

1.  **開始**：流程由案場人員進入「專案退料申請作業」功能頁面開始。
2.  **建立退料單**：
    * 案場人員點擊「新增退料單」按鈕。
3.  **填寫退料資訊**：
    * **表頭**：案場人員需選擇退料來源的「專案」與「案場」，並填寫「退料日期」。
    * **明細**：接著，逐一新增需要退回的物料，包含「物料」、「退回數量」、「物料狀態」（例如：可再用、需檢修、報廢）以及可追溯的「原始批號」。
    * **(系統輔助)**：在選擇物料時，系統可以智能地顯示該專案曾領用過的物料歷史紀錄，幫助使用者快速填寫。
4.  **提交申請**：
    * 確認所有退料項目無誤後，案場人員點擊「提交申請」。
5.  **系統處理**：
    * 系統會先驗證資料的完整性。
    * 驗證通過後，系統會：
        * 自動產生一組唯一的「退料單號 (`ReturnNumber`)」。
        * 將申請資料存入 `Inventory.InternalReturnHeaders` 與 `Inventory.InternalReturnLines` 資料表。
        * 將該筆退料單的 `Status` (狀態) 設為「待接收」或「待審核」。
        * (可選) 發送通知給倉庫管理人員，告知有待接收的退料。
6.  **結束**：退料申請單成功建立，等待後續的審核或接收作業。

### Mermaid 語法

```mermaid
---
title: 1.5.1. 專案退料申請作業流程圖
---
flowchart TD
    %% Node Definitions
    subgraph 案場人員
        A1("開始: 進入<br>專案退料申請作業")
        A2("點擊「新增退料單」")
        A3("選擇退料的「專案」與「案場」")
        A4("新增欲退回的物料明細")
        A5("選擇物料、填寫退回數量、<br>物料狀態、原始批號等")
        A6("點擊「提交申請」")
    end

    subgraph 系統
        B1["系統可輔助顯示<br>該專案的歷史領料紀錄"]
        B2{資料驗證成功？}
        C1("產生退料單號")
        C2("儲存退料單資料至<br>Inventory.InternalReturnHeaders/Lines<br>(狀態: 待接收/待審核)")
        B3("發送通知給倉庫管理人員")
        B4("顯示「提交成功」訊息")
        B5("顯示錯誤訊息")
    end

    %% Link Definitions
    A1 --> A2 --> A3 --> A4 --> A5 --> A6 --> B2
    
    B2 -- "是" --> C1
    C1 --> C2
    C2 --> B3
    C3 --> B4
    B4 --> Z(結束)
    
    B2 -- "否" --> B5
    B5 --> A1
    
    A4 -.-> B1
    style B1 fill:#lightyellow,stroke:#333,stroke-dasharray: 5 5