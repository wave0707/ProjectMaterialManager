# 流程圖：1.3.3. 庫存調撥執行作業

* **文件版本**: 1.0
* **制定日期**: 2025年7月5日
* **制定者**: William He
* **模組**：1.3. 庫存調撥
* **文件狀態**：流程圖語法已更新為 Mermaid。

---

這份流程圖詳細描述了倉管人員根據已核准（或不需審核）的調撥單，執行實體物料搬運，並在系統中完成庫存轉移的完整操作步驟。

### 流程圖說明

1.  **開始**：流程由倉管人員進入「庫存調撥執行作業」功能頁面開始。
2.  **查詢待執行項目**：
    * 系統會自動列出所有狀態為「待執行」或「已核准」的庫存調撥單。
    * 倉管人員從列表中選擇一筆準備執行的調撥單。
3.  **執行實體調撥**：
    * 倉管人員根據調撥單上的指示（物料、數量、來源與目標儲位），進行實體的物料搬運作業。
4.  **確認執行**：
    * 完成實體搬運後，倉管人員在系統上點擊「確認執行」按鈕。
5.  **系統庫存異動**：
    * 這是整個流程的核心，系統會在背景執行一連串的資料庫更新，以一筆**調撥出**與一筆**調撥入**的方式，確保庫存移轉的正確性與可追溯性：
        * **寫入庫存異動日誌**：在 `Inventory.TransactionLogs` 中，針對此作業建立**兩筆**紀錄：
            * **來源端**：新增一筆 `TransactionType` 為「調撥出」的紀錄，`QuantityChange` 為**負數**。
            * **目的端**：新增一筆 `TransactionType` 為「調撥入」的紀錄，`QuantityChange` 為**正數**。
        * **更新即時庫存**：根據異動日誌，同步更新 `Inventory.LotDetails` 中來源端與目的端的即時庫存數量。
        * **更新調撥單狀態**：將 `Inventory.TransferHeaders` 的單據狀態更新為「已完成」。
6.  **結束**：系統顯示「調撥成功」訊息，庫存已成功在系統中完成轉移。

### Mermaid 語法

```mermaid
---
title: 1.3.3. 庫存調撥執行作業流程圖
---
flowchart TD
    %% Node Definitions
    subgraph 倉庫管理人員
        A1("開始: 進入<br>庫存調撥執行作業")
        A2("從列表中選擇<br>一筆調撥單")
        A3("根據調撥單指示<br>執行實體物料搬運")
        A4("點擊「確認執行」")
    end

    subgraph 系統
        B1("顯示所有「待執行/已核准」<br>的調撥單")
        D1("顯示「調撥成功」訊息")
    end

    subgraph "系統後台庫存異動"
        C1["建立兩筆庫存異動日誌<br>(Inventory.TransactionLogs)"]
        C2["更新庫存明細<br>(Inventory.LotDetails) 的數量"]
        C3["更新調撥單主檔<br>(Inventory.TransferHeaders)<br>狀態為「已完成」"]
    end

    subgraph Note1 [異動說明]
         N1["· 來源儲位：交易類型「調撥出」(數量為負)<br>· 目標儲位：交易類型「調撥入」(數量為正)"]
    end

    %% Link Definitions
    A1 --> B1
    B1 --> A2
    A2 --> A3
    A3 --> A4
    A4 --> C1
    
    C1 --> C2
    C2 --> C3
    C3 --> D1
    D1 --> Z(結束)

    C1 -.-> Note1
    style Note1 fill:#lightyellow,stroke:#333,stroke-dasharray: 5 5