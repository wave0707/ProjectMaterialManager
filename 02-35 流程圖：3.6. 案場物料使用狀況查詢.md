# 流程圖：3.6. 案場物料使用狀況查詢

* **文件版本**: 1.0
* **制定日期**: 2025年7月5日
* **制定者**: William He
* **模組**：3. 專案管理
* **文件狀態**：流程圖語法已更新為 Mermaid。

---

這份流程圖詳細描述了權責人員（如：專案經理、監工）如何透過系統，查詢特定案場の物料領用、退回與實際消耗狀況。

### 流程圖說明

1.  **開始**：流程由使用者進入「案場物料使用狀況查詢」功能頁面開始。
2.  **輸入條件**：使用者必須先選擇要查詢的「專案」與「案場」。此外，還可以選擇「物料」或「日期區間」來進一步篩選。
3.  **系統分析與整合**：
    * 使用者點擊「查詢」後，系統會在背景整合多張資料表的資訊，針對查詢範圍內的每一項物料進行計算：
        * **查詢計畫用量**：從 `Project.BOMs` 取得該物料的「計畫需求量」。
        * **查詢總領用量**：從 `Inventory.MaterialIssuanceLines` 加總該物料發料到此案場的「總發料量」。
        * **查詢總退回量**：從 `Inventory.InternalReturnLines` 加總該物料從此案場退回的「總退回量」。
        * **計算實際消耗量**：總發料量 - 總退回量。
        * **計算差異**：實際消耗量 - 計畫需求量。
4.  **顯示分析報告**：
    * 系統將整合後的資訊以報表形式呈現。
    * 報表會清楚列出每一筆物料的「計畫用量」、「總領用量」、「總退回量」、「實際消耗量」及「差異」，讓管理者能快速判斷物料使用是否超量或節餘。
5.  **結束**：使用者獲得清晰的案場物料使用狀況概覽。

### Mermaid 語法

```mermaid
---
title: 3.6. 案場物料使用狀況查詢流程圖
---
flowchart TD
    %% Node Definitions
    subgraph 使用者
        A1("開始: 進入<br>案場物料使用狀況查詢功能")
        A2("選擇&#12300;專案&#12301;、&#12300;案場&#12301;<br>及其他篩選條件")
        A3("點擊&#12300;查詢&#12301;")
    end

    subgraph "系統後台資料整合"
        B1["For each material in scope:<br>· 查詢計畫用量 &#40;Project.BOMs&#41;<br>· 查詢總領用量 &#40;Inventory.MaterialIssuanceLines&#41;<br>· 查詢總退回量 &#40;Inventory.InternalReturnLines&#41;<br>· 計算實際消耗量<br>· 計算用量差異"]
    end

    subgraph 系統
        C1["以報表形式顯示分析結果"]
    end

    subgraph Note1 [報表欄位範例]
        N1["· 計畫用量<br>· 總領用量<br>· 總退回量<br>· 實際消耗量<br>· 差異"]
    end

    %% Link Definitions
    A1 --> A2
    A2 --> A3
    A3 --> B1
    
    B1 --> C1
    C1 --> Z(結束)

    C1 -.-> Note1
    style Note1 fill:#lightyellow,stroke:#333,stroke-dasharray: 5 5