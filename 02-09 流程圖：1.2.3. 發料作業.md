# 流程圖：1.2.3. 發料作業

* **文件版本**: 1.0
* **制定日期**: 2025年7月5日
* **制定者**: William He
* **模組**：1.2. 出庫管理
* **文件狀態**：流程圖語法已更新為 Mermaid。

---

這份流程圖詳細描述了倉管人員根據已核准的領料申請單，從倉庫中揀貨、發料，並在系統中執行扣帳的完整操作步驟。這是**正式異動庫存**的環節。

### 流程圖說明

1.  **開始**：流程由倉管人員收到通知，或主動進入「發料作業」功能頁面開始。
2.  **查詢待發料項目**：
    * 系統會自動列出所有審核狀態為「已核准」且尚未發料的領料申請單。
    * 倉管人員從列表中選擇一筆準備執行發料。
3.  **備貨與揀貨**：
    * 系統顯示該領料單的詳細內容，作為揀貨清單。
    * **(系統輔助)**：為了有效管理庫存，系統應推薦發料的「儲位」與「批號」，常見策略為「先進先出 (FIFO)」，即優先從最早入庫的批次發料。
    * 倉管人員根據系統建議與實際情況，從貨架上揀取物料。
4.  **登錄發料資訊**：
    * 倉管人員在系統上，針對每一個品項，回填實際發出的「數量」、「儲位」及「批號」。
    * 點擊「確認發料」按鈕。
5.  **系統庫存異動**：
    * 這是整個流程的核心，系統會在背景執行一連串的資料庫更新：
        * **建立發料單**：在 `Inventory.MaterialIssuanceHeaders` 與 `Inventory.MaterialIssuanceLines` 中建立正式的發料紀錄。
        * **寫入庫存異動日誌**：在 `Inventory.TransactionLogs` 中，為每一筆發出的物料新增一筆 `TransactionType` 為「發料」的紀錄，`QuantityChange` 為負數。
        * **更新即時庫存**：根據異動日誌，扣減 `Inventory.LotDetails` 中對應物料在特定儲位、特定批號下的即時庫存數量 (`QuantityOnHand`)。
        * **更新庫存總表**：同步更新 `Inventory.MaterialSummaries` 中的物料庫存總量。
6.  **結束**：系統顯示「發料成功」訊息，並可選擇列印「發料單」或「出庫單」，供案場人員簽收。

### Mermaid 語法

```mermaid
---
title: 1.2.3. 發料作業流程圖
---
flowchart TD
    subgraph 倉庫管理人員
        A1("開始: 進入「發料作業」功能") --> B1
        B1 --> A2("從列表中選擇一筆<br>申請單進行發料") --> B2
        B2 --> A3("根據清單與系統建議<br>進行揀貨") --> A4("回填實際發料的<br>數量、儲位、批號") --> A5("點擊「確認發料」") --> C1
    end

    subgraph 系統
        B1("顯示所有「已核准」的<br>領料申請單列表")
        B2("顯示領料單明細<br>(揀貨清單)")
        D1("顯示「發料成功」訊息") --> D2("可選擇列印發料單") --> Z(結束)
    end

    subgraph "系統後台作業"
        C1["建立發料單<br>(Inventory.MaterialIssuanceHeaders/Lines)"]
        C2["新增庫存異動日誌<br>(Inventory.TransactionLogs)<br>交易類型為「發料」(數量為負)"]
        C3["更新庫存明細<br>(Inventory.LotDetails)<br>扣減庫存數量"]
        C4["更新庫存總表<br>(Inventory.MaterialSummaries)<br>扣減物料總庫存"]
    end

    subgraph Note1 [輔助資訊]
        N1["系統可依先進先出(FIFO)原則<br>推薦發料的「儲位」與「批號」"]
    end

    B2 -.-> Note1
    style Note1 fill:#lightyellow,stroke:#333,stroke-dasharray: 5 5

    C1 --> C2 --> C3 --> C4 --> D1